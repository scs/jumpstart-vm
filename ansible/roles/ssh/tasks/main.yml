- name: Install ssh tools
  become: true
  ansible.builtin.package:
    name:
      - xorg
      - xauth
      - openssh-client
      - openssh-server

- name: Add authorized keys
  become: true
  ansible.builtin.authorized_key:
    user: "{{ ansible_env.USER }}"
    state: present
    key: "{{ lookup('file', '{{ item }}') }}"
  with_items:
    - "{{ ssh_pub_files }}"

- name: Allow legacy ssh-rsa key encryption
  become: true
  ansible.builtin.lineinfile:
    dest="/etc/ssh/sshd_config.d/legacy_pubkey_types.conf"
    line="PubkeyAcceptedKeyTypes +ssh-rsa"
    regexp="^PubkeyAcceptedKeyTypes"
    state=present
    insertafter=EOF
    create=True
    mode='0644'
  notify: restart_sshd
